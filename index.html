<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fat Rat: iPhone Edition</title>
  <style>
    :root {
      --bg-top: #111827;
      --bg-bottom: #1f2937;
      --glass: rgba(255, 255, 255, 0.12);
      --glass-strong: rgba(255, 255, 255, 0.2);
      --text: #f8fafc;
      --muted: #cbd5e1;
      --accent: #60a5fa;
      --good: #34d399;
      --danger: #fb7185;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 0%, #3b82f6 0%, transparent 36%),
        radial-gradient(circle at 80% 100%, #8b5cf6 0%, transparent 32%),
        linear-gradient(160deg, var(--bg-top), var(--bg-bottom));
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .top-panel {
      position: sticky;
      top: 0;
      z-index: 30;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.6);
      border-bottom: 1px solid rgba(255,255,255,.15);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(8, minmax(90px, 1fr));
      gap: 8px;
    }

    .pill {
      border-radius: 16px;
      padding: 9px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.2), rgba(255,255,255,.09));
      border: 1px solid rgba(255,255,255,.2);
      text-align: center;
      font-weight: 700;
      font-size: 0.86rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }

    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ios-btn {
      border: none;
      border-radius: 14px;
      padding: 10px 14px;
      color: white;
      background: linear-gradient(180deg, #60a5fa, #2563eb);
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(37,99,235,.35), inset 0 1px 0 rgba(255,255,255,.35);
      cursor: pointer;
    }

    .ios-btn.secondary {
      background: linear-gradient(180deg, #a78bfa, #7c3aed);
      box-shadow: 0 8px 16px rgba(124,58,237,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }

    .ios-btn:disabled {
      opacity: .5;
      cursor: not-allowed;
      box-shadow: none;
    }

    #gameArea {
      margin: 12px;
      border-radius: 24px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.2);
      background: linear-gradient(150deg, rgba(255,255,255,.08), rgba(0,0,0,.35));
      min-height: 68vh;
    }

    .rat {
      position: absolute;
      width: 64px;
      height: 48px;
      border-radius: 54% 46% 50% 50%;
      transform-origin: center;
      transition: transform .08s linear;
      background: radial-gradient(circle at 30% 30%, var(--rat-primary, #f5d0fe), var(--rat-secondary, #a78bfa) 72%);
      box-shadow: inset -10px -8px rgba(0,0,0,.2), 0 8px 12px rgba(0,0,0,.35);
    }
    .rat::before,.rat::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: color-mix(in oklab, var(--rat-primary, #f5d0fe) 80%, white);
      top: -5px;
      border: 2px solid rgba(0,0,0,.2);
    }
    .rat::before { left: 8px; }
    .rat::after { right: 8px; }
    .rat .eye { position: absolute; width: 6px; height: 6px; border-radius: 50%; top: 15px; right: 12px; background: var(--rat-eye, #111); box-shadow: -16px 1px 0 var(--rat-eye, #111); }
    .rat .nose { position: absolute; width: 9px; height: 7px; right: -2px; top: 20px; border-radius: 50%; background: var(--rat-nose, #fb7185); }
    .rat .tail { position: absolute; width: 36px; height: 8px; left: -28px; top: 26px; border-radius: var(--rat-tail-radius, 10px); transform: rotate(-10deg); background: linear-gradient(90deg, var(--rat-tail-a, #c084fc), var(--rat-tail-b, #f9a8d4)); }
    .rat .stripe { position:absolute; left: 8px; top: 8px; width: 36px; height: 4px; border-radius: 8px; background: rgba(255,255,255,.45); transform: rotate(-10deg); }
    .rat .stripe.two { top: 16px; width: 28px; opacity: .7; }

    .food {
      position: absolute;
      width: 28px;
      height: 28px;
      font-size: 24px;
      display: grid;
      place-items: center;
      pointer-events: none;
    }


    .enemy {
      position: absolute;
      width: 50px;
      height: 40px;
      border-radius: 54% 46% 50% 50%;
      background: radial-gradient(circle at 30% 30%, var(--enemy-primary, #d8b4fe), var(--enemy-secondary, #7c3aed) 72%);
      box-shadow: inset -8px -8px rgba(0,0,0,.2), 0 7px 10px rgba(0,0,0,.35);
      filter: drop-shadow(0 6px 6px rgba(0,0,0,.35));
      pointer-events: none;
      transform-origin: center;
      animation: enemy-walk .4s ease-in-out infinite alternate;
    }

    .enemy::before,.enemy::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      top: -4px;
      background: color-mix(in oklab, var(--enemy-primary, #d8b4fe) 85%, white);
      border: 2px solid rgba(0,0,0,.2);
    }
    .enemy::before { left: 8px; }
    .enemy::after { right: 8px; }
    .enemy-tail { position: absolute; width: 28px; height: 7px; left: -21px; top: 22px; border-radius: 8px; transform: rotate(-12deg); background: linear-gradient(90deg,#a78bfa,#f9a8d4); }
    .enemy-eye { position: absolute; width: 5px; height: 5px; border-radius: 50%; top: 13px; right: 10px; background: #111; box-shadow: -14px 1px 0 #111; }
    .enemy-nose { position: absolute; width: 8px; height: 6px; right: -2px; top: 17px; border-radius: 50%; background: #fb7185; }
    .enemy-badge { position: absolute; right: -6px; top: -14px; font-size: 15px; }

    .enemy-hp {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -10px;
      width: 58px;
      height: 7px;
      border-radius: 999px;
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(255,255,255,.25);
      overflow: hidden;
      display: none;
    }

    .enemy-hp-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg,#22c55e,#eab308,#ef4444);
      transform-origin: left;
    }

    .boss-hp-wrap {
      display: none;
      margin-top: 4px;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(15,23,42,.6);
    }

    .boss-hp-track {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(255,255,255,.3);
    }

    .boss-hp-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg,#f97316,#ef4444);
    }

    .pylon {
      position: absolute;
      width: 56px;
      height: 76px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.35);
      background: linear-gradient(180deg, var(--pylon-a,#7dd3fc), var(--pylon-b,#0c4a6e));
      box-shadow: 0 0 20px rgba(125,211,252,.45);
      pointer-events: none;
      z-index: 7;
    }

    .pylon-label { position:absolute; top:-18px; left:50%; transform:translateX(-50%); font-size:11px; font-weight:800; white-space:nowrap; }

    .enemy-bullet {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle at 32% 32%, #fef3c7, #f97316 70%);
      border: 1px solid rgba(255,255,255,.5);
      box-shadow: 0 0 0 2px rgba(249,115,22,.18), 0 0 12px rgba(249,115,22,.55);
      pointer-events: none;
      z-index: 6;
    }

    .pickup {
      position: absolute;
      width: 30px;
      height: 30px;
      font-size: 24px;
      display: grid;
      place-items: center;
      pointer-events: none;
    }

    .helper-rat {
      position: absolute;
      width: 28px;
      height: 22px;
      border-radius: 52% 48% 50% 50%;
      background: radial-gradient(circle at 30% 30%, #fde68a, #f59e0b 72%);
      box-shadow: inset -6px -5px rgba(0,0,0,.2), 0 5px 8px rgba(0,0,0,.3);
      pointer-events: none;
      animation: helper-walk .32s ease-in-out infinite alternate;
      transform-origin: center;
    }

    .helper-rat::before,
    .helper-rat::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      top: -3px;
      background: #fef3c7;
    }
    .helper-rat::before { left: 4px; }
    .helper-rat::after { right: 4px; }
    .helper-tail { position: absolute; width: 16px; height: 4px; left: -12px; top: 12px; border-radius: 8px; background: #fda4af; }
    .helper-eye { position: absolute; width: 4px; height: 4px; border-radius: 50%; top: 8px; right: 6px; background: #111; box-shadow: -8px 1px 0 #111; }

    @keyframes enemy-walk { from { transform: translateY(0) rotate(-2deg); } to { transform: translateY(1px) rotate(2deg); } }
    @keyframes helper-walk { from { transform: translateY(0) scale(1); } to { transform: translateY(1px) scale(1.03); } }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
      backdrop-filter: blur(8px);
    }

    .modal.open { display: flex; }

    .sheet {
      width: min(760px, 100%);
      max-height: 85vh;
      overflow: auto;
      border-radius: 22px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.12));
      border: 1px solid rgba(255,255,255,.25);
    }

    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 10px 0; }
    .card { border-radius: 16px; padding: 12px; background: rgba(15,23,42,.45); border: 1px solid rgba(255,255,255,.15); }

    input, select {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(15,23,42,.45);
      color: white;
      padding: 8px;
    }

    .leaderboard-item { display: grid; grid-template-columns: 28px 1fr auto; gap: 8px; padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,.1); }
    .status { font-weight: 700; min-height: 22px; color: #fde68a; margin-top: 6px; }

    .wave-pop {
      position: fixed;
      left: 50%;
      top: 18%;
      transform: translate(-50%, -20px) scale(.9);
      padding: 16px 22px;
      border-radius: 16px;
      background: rgba(15,23,42,.88);
      border: 1px solid rgba(255,255,255,.28);
      box-shadow: 0 18px 36px rgba(0,0,0,.35);
      font-weight: 800;
      z-index: 80;
      opacity: 0;
      pointer-events: none;
      transition: opacity .35s ease, transform .35s ease;
    }

    .wave-pop.show {
      opacity: 1;
      transform: translate(-50%, 0) scale(1);
    }

    .mobile-controls {
      position: fixed;
      z-index: 45;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      width: min(340px, calc(100vw - 24px));
      display: none;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 10px;
      border-radius: 18px;
      backdrop-filter: blur(10px);
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(255,255,255,.2);
    }

    .pad-btn {
      border: none;
      border-radius: 14px;
      min-height: 48px;
      font-size: 1.3rem;
      color: white;
      background: linear-gradient(180deg, rgba(96,165,250,.95), rgba(37,99,235,.95));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      touch-action: none;
    }

    .pad-btn.empty { visibility: hidden; }

    .mode-chip {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(2,6,23,.35);
      font-size: .8rem;
      margin-top: 4px;
    }

    .small-input {
      width: 90px;
      text-align: center;
    }

    @media (max-width: 760px) {
      .stats { grid-template-columns: repeat(3, 1fr); }
      #gameArea { min-height: 58vh; margin-bottom: 130px; }
      .mobile-controls { display: grid; }
    }
  </style>
</head>
<body>
  <header class="top-panel">
    <div class="stats">
      <div class="pill">üêÄ Fat <span id="fatStat">0</span></div>
      <div class="pill">üßÄ Coins <span id="coinStat">0</span></div>
      <div class="pill">üìà Earned <span id="earnedStat">0</span></div>
      <div class="pill">üåç <span id="zoneStat">Alley</span></div>
      <div class="pill">‚ö° <span id="modeStat">Classic</span></div>
      <div class="pill">üî• Combo <span id="comboStat">x1</span></div>
      <div class="pill">‚ù§Ô∏è HP <span id="hpStat">100</span></div>
      <div class="pill">üåä Wave <span id="waveStat">1</span></div>
      <div class="pill">üê£ Helpers <span id="helperStat">0</span></div>
    </div>
    <div class="button-row">
      <button class="ios-btn" id="openShopBtn">Boosts</button>
      <button class="ios-btn secondary" id="openZonesBtn">Zones</button>
      <button class="ios-btn" id="openRatBtn">Customize Rat</button>
      <button class="ios-btn secondary" id="openPcBtn">PC Accessories</button>
      <button class="ios-btn secondary" id="openLeaderboardBtn">World Leaderboard</button>
      <button class="ios-btn" id="openModesBtn">Game Modes</button>
    </div>
    <div class="pill">Move with WASD / Arrow Keys ‚Ä¢ Survive waves</div>
    <div class="status" id="statusMsg"></div>
    <div id="wavePopup" class="wave-pop" aria-live="polite"></div>
    <div class="boss-hp-wrap" id="bossHpWrap">
      <div id="bossHpLabel" style="font-weight:700;margin-bottom:4px">KING RAT üëë 1000/1000 HP</div>
      <div class="boss-hp-track"><div class="boss-hp-fill" id="bossHpFill"></div></div>
    </div>
  </header>

  <main id="gameArea" aria-label="Fat Rat Game Arena">
    <div id="rat" class="rat"><span class="tail"></span><span class="eye"></span><span class="nose"></span></div>
  </main>

  <div class="modal" id="shopModal">
    <div class="sheet">
      <div class="row"><h2>üõí Boost Shop</h2><button class="ios-btn secondary" data-close="#shopModal">Close</button></div>
      <div id="shopList"></div>
      <div class="card" id="helperRarityList" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="modal" id="zonesModal">
    <div class="sheet">
      <div class="row"><h2>üîì Zones</h2><button class="ios-btn secondary" data-close="#zonesModal">Close</button></div>
      <div id="zonesList"></div>
    </div>
  </div>

  <div class="modal" id="ratModal">
    <div class="sheet">
      <div class="row"><h2>üé® Customize Rat</h2><button class="ios-btn secondary" data-close="#ratModal">Close</button></div>
      <div class="card">
        <div class="row"><label>Rat Name</label><input id="ratNameInput" maxlength="18" placeholder="Chunky" /></div>
        <div class="row"><label>Primary Color</label><input id="ratPrimaryInput" type="color" value="#f5d0fe" /></div>
        <div class="row"><label>Secondary Color</label><input id="ratSecondaryInput" type="color" value="#a78bfa" /></div>
        <div class="row"><label>Eye Color</label><input id="ratEyeInput" type="color" value="#111111" /></div>
        <div class="row"><label>Nose Color</label><input id="ratNoseInput" type="color" value="#fb7185" /></div>
        <div class="row"><label>Tail Style</label><select id="ratTailInput"><option value="smooth">Smooth</option><option value="chunky">Chunky</option><option value="spike">Spike</option></select></div>
        <div class="row"><label>Pattern</label><select id="ratPatternInput"><option value="none">None</option><option value="stripes">Stripes</option></select></div>
        <div class="row"><label>Accessory</label>
          <select id="ratAccessoryInput">
            <option value="none">None</option>
            <option value="crown">Crown üëë</option>
            <option value="cap">Cap üß¢</option>
            <option value="glasses">Glasses üï∂Ô∏è</option>
          </select>
        </div>
        <button class="ios-btn" id="saveRatBtn">Save Customization</button>
      </div>
    </div>
  </div>


  <div class="modal" id="pcModal">
    <div class="sheet">
      <div class="row"><h2>üíª PC Accessories</h2><button class="ios-btn secondary" data-close="#pcModal">Close</button></div>
      <div class="card" style="margin-bottom:10px">Equipped accessories spawn in the arena as pickups for bonus coins/fat.</div>
      <div id="pcList"></div>
    </div>
  </div>

  <div class="modal" id="modesModal">
    <div class="sheet">
      <div class="row"><h2>üéÆ Game Modes</h2><button class="ios-btn secondary" data-close="#modesModal">Close</button></div>
      <div id="modesList"></div>
    </div>
  </div>

  <div class="modal" id="leaderboardModal">
    <div class="sheet">
      <div class="row"><h2>üèÜ World Leaderboard</h2><button class="ios-btn secondary" data-close="#leaderboardModal">Close</button></div>
      <div class="card">
        <div><strong>Auto-sync is ON</strong></div>
        <div style="color: var(--muted); margin-top:6px">Your rat is added/updated automatically while you play via online API.</div>
        <div id="myRankText" style="margin-top:8px;font-weight:700"></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div id="leaderboardList"></div>
      </div>
    </div>
  </div>

  <div class="mobile-controls" id="mobileControls" aria-label="Touch controls">
    <button class="pad-btn empty" tabindex="-1">‚Ä¢</button>
    <button class="pad-btn" data-touch="up">‚¨ÜÔ∏è</button>
    <button class="pad-btn empty" tabindex="-1">‚Ä¢</button>
    <button class="pad-btn" data-touch="left">‚¨ÖÔ∏è</button>
    <button class="pad-btn" data-touch="down">‚¨áÔ∏è</button>
    <button class="pad-btn" data-touch="right">‚û°Ô∏è</button>
  </div>

  <script>
    const zones = [
      { name: "Alley", unlockAt: 0, foodRate: 1120, foodFat: 1, bg: "linear-gradient(160deg,#334155,#1e293b)" },
      { name: "Food Court", unlockAt: 35, foodRate: 920, foodFat: 2, bg: "linear-gradient(160deg,#065f46,#022c22)" },
      { name: "Mega Buffet", unlockAt: 90, foodRate: 780, foodFat: 3, bg: "linear-gradient(160deg,#7f1d1d,#450a0a)" },
      { name: "Cosmic Kitchen", unlockAt: 180, foodRate: 660, foodFat: 4, bg: "linear-gradient(160deg,#312e81,#1e1b4b)" },
      { name: "Sewer Speedway", unlockAt: 280, foodRate: 620, foodFat: 5, bg: "linear-gradient(160deg,#0f766e,#134e4a)" },
      { name: "Neon Diner", unlockAt: 420, foodRate: 560, foodFat: 6, bg: "linear-gradient(160deg,#7e22ce,#4c1d95)" },
      { name: "Sky Snack Deck", unlockAt: 600, foodRate: 520, foodFat: 7, bg: "linear-gradient(160deg,#1d4ed8,#1e3a8a)" },
      { name: "Volcano Grill", unlockAt: 820, foodRate: 480, foodFat: 8, bg: "linear-gradient(160deg,#b91c1c,#7f1d1d)" },
      { name: "Candy Crater", unlockAt: 1080, foodRate: 450, foodFat: 9, bg: "linear-gradient(160deg,#be185d,#831843)" },
      { name: "Royal Fridge", unlockAt: 1400, foodRate: 420, foodFat: 10, bg: "linear-gradient(160deg,#4338ca,#1e1b4b)" },
      { name: "Burger Galaxy", unlockAt: 1800, foodRate: 390, foodFat: 12, bg: "linear-gradient(160deg,#0f172a,#020617)" },
      { name: "Infinity Pantry", unlockAt: 2300, foodRate: 350, foodFat: 14, bg: "linear-gradient(160deg,#14532d,#052e16)" },
      { name: "God Rat Realm", unlockAt: 3000, foodRate: 300, foodFat: 18, bg: "linear-gradient(160deg,#4c0519,#111827)" },
      { name: "Cheese Singularity", unlockAt: 4000, foodRate: 260, foodFat: 25, bg: "linear-gradient(160deg,#713f12,#292524)" }
    ];

    const shopItems = [
      { id: "speed", name: "Rocket Sneakers", cost: 12, max: 10, desc: "+0.9 movement speed", apply: s => s.speed += 0.9 },
      { id: "mult", name: "Grease Booster", cost: 20, max: 35, desc: "+1 fat per bite", apply: s => s.fatPerFood += 1 },
      { id: "burner", name: "Fat Burner", cost: 52, max: 12, desc: "Slows rat growth and shrinks current fat", apply: s => { s.fatBurnerLevel += 1; s.fat = Math.max(0, Math.floor(s.fat * 0.92)); } },
      { id: "spawn", name: "Snack Magnet", cost: 28, max: 10, desc: "Faster food spawns", apply: s => s.spawnBoost += 160 },
      { id: "coin", name: "Golden Whiskers", cost: 25, max: 10, desc: "+1 coin per food", apply: s => s.coinBoost += 1 },
      { id: "armor", name: "Cheese Armor", cost: 34, max: 18, desc: "+10 max HP", apply: s => { s.maxHp += 10; s.hp = Math.min(s.maxHp, s.hp + 8); } },
      { id: "regen", name: "Regeneration Soda", cost: 45, max: 18, desc: "+0.12 HP regen", apply: s => s.hpRegen += 0.12 },
      { id: "damage", name: "Spicy Bite", cost: 38, max: 20, desc: "+1 rat damage", apply: s => s.damage += 1 },
      { id: "vacuum", name: "Vacuum Belly", cost: 50, max: 15, desc: "+4 pickup hitbox", apply: s => s.hitboxBonus += 4 },
      { id: "fangs", name: "Steel Fangs", cost: 56, max: 12, desc: "+2 attack", apply: s => s.damage += 2 },
      { id: "shell", name: "Titan Shell", cost: 62, max: 15, desc: "+2 defense", apply: s => s.defense += 2 },
      { id: "vital", name: "Giga Vitamins", cost: 60, max: 12, desc: "+18 max HP", apply: s => { s.maxHp += 18; s.hp = Math.min(s.maxHp, s.hp + 12); } },
      { id: "helper", name: "Rat Whistle", cost: 95, max: 5, desc: "Roll helper rat (max 5)", apply: s => addHelperFromRoll() },
      { id: "defpierce", name: "Defense Piercer", cost: 300, max: 10, desc: "+50 defense pierce", apply: s => s.playerDefensePierce += 50 }
    ];

    const helperRarityTable = [
      { type: "Brawler Rat", rarity: "Common", chance: 50, attack: 1.8, range: 96, style: "melee", icon: "ü•ä" },
      { type: "Sword Rat", rarity: "Rare", chance: 28, attack: 3.2, range: 108, style: "melee", icon: "üó°Ô∏è" },
      { type: "Shooter Rat", rarity: "Epic", chance: 16, attack: 2.7, range: 190, style: "ranged", icon: "üî´" },
      { type: "Sniper Rat", rarity: "Legendary", chance: 6, attack: 5, range: 250, style: "ranged", icon: "üéØ" }
    ];

    const gameModes = [
      { id: "classic", name: "Classic", desc: "Balanced gameplay.", fatMul: 1, spawnMul: 1, coinBonus: 0, enemyMul: 1 },
      { id: "feast", name: "Feast Frenzy", desc: "Way more food and fat gain.", fatMul: 1.35, spawnMul: 0.75, coinBonus: 1, enemyMul: 0.95 },
      { id: "rush", name: "Turbo Rush", desc: "Fast rat, faster zone progression.", fatMul: 1.15, spawnMul: 0.85, coinBonus: 0, enemyMul: 1.05 },
      { id: "challenge", name: "Grease Challenge", desc: "Hard mode, but juicy rewards.", fatMul: 1.6, spawnMul: 1.25, coinBonus: 2, enemyMul: 1.2 },
      { id: "survival", name: "Rat Survival", desc: "Enemies hit harder, rewards scale.", fatMul: 1.5, spawnMul: 1.15, coinBonus: 2, enemyMul: 1.35 },
      { id: "bossrush", name: "Boss Rush", desc: "Bosses spawn faster.", fatMul: 1.35, spawnMul: 1.05, coinBonus: 2, enemyMul: 1.55 }
    ];

    const accessoryShopItems = [
      { id: "keyboard", name: "RGB Keyboard", cost: 70, bonus: "+0.5 speed", spawn: "‚å®Ô∏è", effect: s => s.speed += 0.5 },
      { id: "mouse", name: "Pro Mouse", cost: 80, bonus: "+1 damage", spawn: "üñ±Ô∏è", effect: s => s.damage += 1 },
      { id: "gpu", name: "Rat RTX", cost: 120, bonus: "+10% fat gain", spawn: "üß©", effect: s => s.pcFatBonus += 0.1 },
      { id: "headset", name: "Gamer Headset", cost: 90, bonus: "+0.15 HP regen", spawn: "üéß", effect: s => s.hpRegen += 0.15 },
      { id: "chair", name: "Tank Chair", cost: 110, bonus: "+3 defense", spawn: "ü™ë", effect: s => s.defense += 3 },
      { id: "mic", name: "Battle Mic", cost: 100, bonus: "+2 attack", spawn: "üéôÔ∏è", effect: s => s.damage += 2 },
      { id: "monitor", name: "Ultra Monitor", cost: 125, bonus: "+14 max HP", spawn: "üñ•Ô∏è", effect: s => { s.maxHp += 14; s.hp = Math.min(s.maxHp, s.hp + 10); } }
    ];

    const state = {
      fat: 0,
      coins: 0,
      totalFatEarned: 0,
      speed: 3.2,
      fatPerFood: 1,
      spawnBoost: 0,
      coinBoost: 0,
      zoneIndex: 0,
      highestUnlockedZone: 0,
      keys: {},
      foods: [],
      lastSpawn: 0,
      rat: { x: 220, y: 180, w: 64, h: 48 },
      ratName: "Chunky",
      ratPrimary: "#f5d0fe",
      ratSecondary: "#a78bfa",
      ratEye: "#111111",
      ratNose: "#fb7185",
      ratTail: "smooth",
      ratPattern: "none",
      ratAccessory: "none",
      currentMode: "classic",
      modeFatMultiplier: 1,
      modeSpawnMultiplier: 1,
      modeCoinBonus: 0,
      modeEnemyMultiplier: 1,
      combo: 1,
      hp: 100,
      maxHp: 100,
      hpRegen: 0.08,
      damage: 2,
      defense: 0,
      helperCount: 0,
      helperAttack: 1.4,
      helperRats: [],
      helperInventory: [],
      boostPurchases: {},
      hitboxBonus: 0,
      wave: 1,
      waveSpawnLeft: 0,
      waveSpawnTick: 0,
      waveStarted: false,
      enemies: [],
      enemyBullets: [],
      pickups: [],
      lastEnemySpawn: 0,
      lastPickupSpawn: 0,
      pcOwned: {},
      pcEquipped: {},
      pcFatBonus: 0,
      bossEnemyId: null,
      wave20BossSpawned: false,
      wave30BossSpawned: false,
      wave40BossSpawned: false,
      fatBurnerLevel: 0,
      regenBlockedUntil: 0,
      slowedUntil: 0,
      vulnUntil: 0,
      playerDefensePierce: 0,
      bossMilestoneSpawned: {},
      lunaticSpawned: false,
      pylons: [],
      pylonLastSpawn: 0,
      touch: { up: false, down: false, left: false, right: false },
      playerId: localStorage.getItem("fatRatPlayerId") || crypto.randomUUID(),
      remoteBoard: [],
      leaderboardError: "",
      lastSubmittedFat: Number(localStorage.getItem("fatRatLastSubmittedFat") || -1),
      leaderboardSyncInFlight: false,
      uiDirty: true
    };

    const gameArea = document.getElementById("gameArea");
    const ratEl = document.getElementById("rat");
    const fatStat = document.getElementById("fatStat");
    const coinStat = document.getElementById("coinStat");
    const earnedStat = document.getElementById("earnedStat");
    const zoneStat = document.getElementById("zoneStat");
    const modeStat = document.getElementById("modeStat");
    const comboStat = document.getElementById("comboStat");
    const hpStat = document.getElementById("hpStat");
    const waveStat = document.getElementById("waveStat");
    const helperStat = document.getElementById("helperStat");
    const statusMsg = document.getElementById("statusMsg");
    const bossHpWrap = document.getElementById("bossHpWrap");
    const bossHpFill = document.getElementById("bossHpFill");
    const bossHpLabel = document.getElementById("bossHpLabel");
    const shopList = document.getElementById("shopList");
    const zonesList = document.getElementById("zonesList");
    const pcList = document.getElementById("pcList");
    const modesList = document.getElementById("modesList");
    const leaderboardList = document.getElementById("leaderboardList");
    const myRankText = document.getElementById("myRankText");
    const wavePopup = document.getElementById("wavePopup");
    const helperRarityList = document.getElementById("helperRarityList");
    localStorage.setItem("fatRatPlayerId", state.playerId);

    function currentZone() { return zones[state.zoneIndex]; }

    function getPlayerAttack() {
      let attack = state.damage;
      if (state.pcEquipped.mouse) attack += 1;
      if (state.pcEquipped.mic) attack += 2;
      return attack;
    }

    function getPlayerDefense() {
      let defense = state.defense;
      if (state.pcEquipped.chair) defense += 3;
      return defense;
    }

    function getPlayerMaxHp() {
      let maxHp = state.maxHp;
      if (state.pcEquipped.monitor) maxHp += 14;
      return maxHp;
    }

    function getPlayerHpRegen() {
      let regen = state.hpRegen;
      if (state.pcEquipped.headset) regen += 0.15;
      return regen;
    }

    function getPlayerFatBonus() {
      let bonus = state.pcFatBonus;
      if (state.pcEquipped.gpu) bonus += 0.1;
      return bonus;
    }

    function setStatus(msg, color = "#fde68a") {
      statusMsg.textContent = msg;
      statusMsg.style.color = color;
      clearTimeout(setStatus.timer);
      setStatus.timer = setTimeout(() => (statusMsg.textContent = ""), 2000);
    }

    function openModal(id) { document.querySelector(id).classList.add("open"); }
    function closeModal(id) { document.querySelector(id).classList.remove("open"); }

    function renderHUD() {
      fatStat.textContent = state.fat;
      coinStat.textContent = state.coins;
      earnedStat.textContent = state.totalFatEarned;
      zoneStat.textContent = currentZone().name;
      modeStat.textContent = gameModes.find(m => m.id === state.currentMode)?.name || "Classic";
      comboStat.textContent = `x${state.combo.toFixed(1)}`;
      state.hp = Math.min(state.hp, getPlayerMaxHp());
      hpStat.textContent = `${Math.round(state.hp)}/${Math.round(getPlayerMaxHp())}${Date.now() < state.regenBlockedUntil ? " üö´Regen" : ""}${Date.now() < state.slowedUntil ? " üßäSlow" : ""}`;
      waveStat.textContent = state.wave;
      helperStat.textContent = state.helperCount;
      gameArea.style.background = currentZone().bg;

      const burnerGrowthMul = Math.max(0.28, 1 - state.fatBurnerLevel * 0.07);
      const visualScale = Math.min(1 + state.fat * 0.016 * burnerGrowthMul, 3.4);
      ratEl.style.transform = `scale(${visualScale})`;

      // Bigger fat = bigger collection hitbox
      const hitboxScale = Math.min(1 + state.fat * 0.01 * burnerGrowthMul, 3.2);
      const pcHitboxBonus = state.pcEquipped.keyboard ? 8 : 0;
      state.rat.w = 64 * hitboxScale + state.hitboxBonus + pcHitboxBonus;
      state.rat.h = 48 * hitboxScale + state.hitboxBonus + pcHitboxBonus;

      ratEl.style.setProperty("--rat-primary", state.ratPrimary);
      ratEl.style.setProperty("--rat-secondary", state.ratSecondary);
      ratEl.style.setProperty("--rat-eye", state.ratEye);
      ratEl.style.setProperty("--rat-nose", state.ratNose);
      ratEl.style.setProperty("--rat-tail-radius", state.ratTail === "chunky" ? "16px" : state.ratTail === "spike" ? "2px" : "10px");
      ratEl.style.setProperty("--rat-tail-a", state.ratTail === "spike" ? "#f97316" : "#c084fc");
      ratEl.style.setProperty("--rat-tail-b", state.ratTail === "spike" ? "#ef4444" : "#f9a8d4");
      ratEl.dataset.accessory = state.ratAccessory;
      ratEl.textContent = "";
      ratEl.insertAdjacentHTML("beforeend", `<span class="tail"></span><span class="eye"></span><span class="nose"></span>${state.ratPattern === "stripes" ? `<span class="stripe"></span><span class="stripe two"></span>` : ""}${accessoryHTML(state.ratAccessory)}`);
    }

    function accessoryHTML(accessory) {
      if (accessory === "crown") return `<span style="position:absolute;top:-20px;left:20px;font-size:20px">üëë</span>`;
      if (accessory === "cap") return `<span style="position:absolute;top:-18px;left:18px;font-size:20px">üß¢</span>`;
      if (accessory === "glasses") return `<span style="position:absolute;top:10px;left:14px;font-size:18px">üï∂Ô∏è</span>`;
      return "";
    }

    function renderHelperRarityList() {
      const counts = state.helperInventory.reduce((acc, helper) => {
        acc[helper.rarity] = (acc[helper.rarity] || 0) + 1;
        return acc;
      }, {});
      helperRarityList.innerHTML = `<strong>üé≤ Helper Rat Rarity List</strong><div style="margin-top:6px;color:var(--muted)">Buying Rat Whistle rolls one helper type.</div>` +
        helperRarityTable.map(h => `<div style="margin-top:6px">${h.icon} <strong>${h.type}</strong> ‚Ä¢ ${h.rarity} ‚Ä¢ ${h.chance}% ‚Ä¢ ATK ${h.attack} ‚Ä¢ ${h.style === "ranged" ? `Range ${h.range}` : `Melee ${h.range}px`} ‚Ä¢ Owned: ${counts[h.rarity] || 0}</div>`).join("");
    }


    function getBoostMax(item) {
      return item.max + Math.floor(state.wave / 10) * 25;
    }

    function renderShop() {
      shopList.innerHTML = "";
      shopItems.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        const bought = state.boostPurchases[item.id] || 0;
        const itemMax = getBoostMax(item);
        const atCap = itemMax && bought >= itemMax;
        card.innerHTML = `<div class="row"><div><strong>${item.name}</strong><div>${item.desc}</div><div>${item.cost} coins each ‚Ä¢ ${bought}/${itemMax || "‚àû"}</div></div><div><input class="small-input" type="number" min="1" value="1" data-qty="${item.id}" /><button class="ios-btn" data-buy="${item.id}" data-amount="1" ${(state.coins >= item.cost && !atCap) ? "" : "disabled"}>Buy 1</button><button class="ios-btn secondary" data-buy="${item.id}" data-amount="custom" ${atCap ? "disabled" : ""}>Buy x</button></div></div>`;
        shopList.appendChild(card);
      });
    }

    function renderPcShop() {
      pcList.innerHTML = "";
      accessoryShopItems.forEach(item => {
        const owned = state.pcOwned[item.id] || 0;
        const equipped = !!state.pcEquipped[item.id];
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<div class="row"><div><strong>${item.name}</strong><div>${item.bonus}</div><div>Cost: ${item.cost} coins ‚Ä¢ Owned: ${owned}</div><div>Spawn pickup: ${item.spawn}</div></div><div><button class="ios-btn" data-pc-buy="${item.id}" ${state.coins >= item.cost ? "" : "disabled"}>Buy</button><button class="ios-btn secondary" data-pc-equip="${item.id}" ${owned < 1 ? "disabled" : ""}>${equipped ? "Unequip" : "Equip"}</button></div></div>`;
        pcList.appendChild(card);
      });
    }

    function renderZones() {
      zonesList.innerHTML = "";
      zones.forEach((zone, idx) => {
        const open = state.totalFatEarned >= zone.unlockAt;
        const current = idx === state.zoneIndex;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<div class="row"><div><strong>${zone.name}</strong><div>Unlock: ${zone.unlockAt} fat</div><div>Food bonus: +${zone.foodFat - 1}</div></div><button class="ios-btn secondary" data-zone="${idx}" ${(!open || current) ? "disabled" : ""}>${current ? "Current" : open ? "Travel" : "Locked"}</button></div>`;
        zonesList.appendChild(card);
      });
    }

    function renderModes() {
      modesList.innerHTML = "";
      gameModes.forEach(mode => {
        const active = state.currentMode === mode.id;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<div class="row"><div><strong>${mode.name}</strong><div>${mode.desc}</div><div class="mode-chip">Fat x${mode.fatMul} ‚Ä¢ Spawn x${mode.spawnMul} ‚Ä¢ +${mode.coinBonus} coins</div></div><button class="ios-btn" data-mode="${mode.id}" ${active ? "disabled" : ""}>${active ? "Active" : "Play"}</button></div>`;
        modesList.appendChild(card);
      });
    }

    function setGameMode(id) {
      const mode = gameModes.find(x => x.id === id);
      if (!mode) return;
      state.currentMode = mode.id;
      state.modeFatMultiplier = mode.fatMul;
      state.modeSpawnMultiplier = mode.spawnMul;
      state.modeCoinBonus = mode.coinBonus;
      state.modeEnemyMultiplier = mode.enemyMul || 1;
      state.uiDirty = true;
      setStatus(`Mode switched: ${mode.name}`, "#93c5fd");
    }

    const LEADERBOARD_API_BASE = "https://geraldburke.com/apps/simple-leaderboard/";
    const LEADERBOARD_GAME_ID = 32;

    function boardStorageKey() {
      const url = new URL(window.location.href);
      const board = (url.searchParams.get("board") || "global").replace(/[^a-z0-9_-]/gi, "").toLowerCase() || "global";
      return `fatRatWorldBoard:${board}`;
    }

    function readLocalBoard() {
      return JSON.parse(localStorage.getItem(boardStorageKey()) || "[]");
    }

    function writeLocalBoard(entries) {
      localStorage.setItem(boardStorageKey(), JSON.stringify(entries));
    }

    function normalizeLeaderboardPayload(payload) {
      if (!payload) return [];
      const rows = Array.isArray(payload)
        ? payload
        : payload.entries || payload.leaderboard || payload.scores || payload.data || [];

      return (Array.isArray(rows) ? rows : []).map(entry => {
        const id = String(entry.player_id || entry.playerId || entry.id || `legacy-${entry.name || entry.player || "rat"}`);
        const name = String(entry.name || entry.player || "Rat").slice(0, 18);
        const fat = Number(entry.score ?? entry.fat ?? entry.points ?? 0) || 0;
        return { id, name, fat };
      });
    }

    function buildLeaderboardUrl(params) {
      const search = new URLSearchParams(params);
      return `${LEADERBOARD_API_BASE}?${search.toString()}`;
    }

    async function fetchJsonLoose(url) {
      const response = await fetch(url, { method: "GET", mode: "cors" });
      if (!response.ok) return null;
      const text = await response.text();
      if (!text) return null;
      try {
        return JSON.parse(text);
      } catch (err) {
        const trimmed = text.trim();
        if ((trimmed.startsWith("{") && trimmed.endsWith("}")) || (trimmed.startsWith("[") && trimmed.endsWith("]"))) {
          return JSON.parse(trimmed);
        }
        return null;
      }
    }

    function jsonpRequest(params, timeoutMs = 6000) {
      return new Promise((resolve, reject) => {
        const callbackName = `fatRatJsonp_${Date.now()}_${Math.random().toString(36).slice(2)}`;
        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        function cleanup() {
          clearTimeout(timer);
          delete window[callbackName];
          script.remove();
        }

        window[callbackName] = payload => {
          cleanup();
          resolve(payload);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("JSONP failed"));
        };

        script.src = buildLeaderboardUrl({ ...params, callback: callbackName });
        document.head.appendChild(script);
      });
    }

    async function fetchRemoteLeaderboard() {
      const getVariants = [
        { action: "get", game_id: String(LEADERBOARD_GAME_ID) },
        { action: "get", game: String(LEADERBOARD_GAME_ID) },
        { action: "list", game_id: String(LEADERBOARD_GAME_ID) },
        { game_id: String(LEADERBOARD_GAME_ID) },
        { game: String(LEADERBOARD_GAME_ID) }
      ];

      for (const params of getVariants) {
        try {
          const payload = await fetchJsonLoose(buildLeaderboardUrl(params));
          const entries = normalizeLeaderboardPayload(payload);
          if (entries.length) {
            state.remoteBoard = entries;
            state.leaderboardError = "";
            return entries;
          }
        } catch (err) {
          // try next payload format
        }
      }

      for (const params of getVariants) {
        try {
          const payload = await jsonpRequest(params);
          const entries = normalizeLeaderboardPayload(payload);
          if (entries.length) {
            state.remoteBoard = entries;
            state.leaderboardError = "";
            return entries;
          }
        } catch (err) {
          // try next JSONP format
        }
      }

      state.leaderboardError = "API unavailable, showing cached/local leaderboard.";
      return [];
    }

    async function refreshLeaderboardFromApi() {
      const entries = await fetchRemoteLeaderboard();
      if (entries.length) state.uiDirty = true;
      renderLeaderboard();
      return entries;
    }

    async function submitRemoteScore(entry) {
      const submitVariants = [
        { action: "add", game_id: String(LEADERBOARD_GAME_ID), player_id: entry.id, name: entry.name, score: String(entry.fat) },
        { action: "submit", game_id: String(LEADERBOARD_GAME_ID), player_id: entry.id, name: entry.name, score: String(entry.fat) },
        { action: "add", game: String(LEADERBOARD_GAME_ID), player: entry.name, player_id: entry.id, points: String(entry.fat) },
        { game_id: String(LEADERBOARD_GAME_ID), player_id: entry.id, name: entry.name, score: String(entry.fat) }
      ];

      for (const params of submitVariants) {
        const url = buildLeaderboardUrl(params);
        try {
          const payload = await fetchJsonLoose(url);
          if (payload && payload.success === false) continue;
          return true;
        } catch (err) {
          // fallback to beacon image for static-hosted CORS limits
          const ping = new Image();
          ping.src = `${url}&_=${Date.now()}`;
          return true;
        }
      }

      return false;
    }

    function upsertLocalScore(entry) {
      const board = readLocalBoard();
      const existing = board.find(x => x.id === entry.id);
      if (existing && existing.fat >= entry.fat && existing.name === entry.name) return false;
      const updated = board.filter(x => x.id !== entry.id);
      updated.push(entry);
      writeLocalBoard(updated);
      return true;
    }

    async function syncMyScore(force = false) {
      if (state.leaderboardSyncInFlight) return;
      const mine = { id: state.playerId, name: state.ratName || "Chunky", fat: state.totalFatEarned };
      const changed = upsertLocalScore(mine);

      if (!force && !changed && mine.fat <= state.lastSubmittedFat) return;

      state.leaderboardSyncInFlight = true;
      const ok = await submitRemoteScore(mine);
      if (ok) {
        state.lastSubmittedFat = mine.fat;
        localStorage.setItem("fatRatLastSubmittedFat", String(state.lastSubmittedFat));
      }
      state.leaderboardSyncInFlight = false;
    }

    function combineBoards() {
      const npc = [
        { id: "npc-1", name: "BurgerBeast", fat: 420 },
        { id: "npc-2", name: "FriesPhantom", fat: 350 },
        { id: "npc-3", name: "CheeseWhale", fat: 260 },
        { id: "npc-4", name: "GreaseKing", fat: 200 }
      ];

      const map = new Map();
      [...readLocalBoard(), ...state.remoteBoard, ...npc].forEach(entry => {
        const id = entry.id || `legacy-${entry.name}`;
        const prev = map.get(id);
        if (!prev || (entry.fat || 0) > (prev.fat || 0)) map.set(id, { id, name: entry.name || "Rat", fat: Number(entry.fat) || 0 });
      });

      return [...map.values()].sort((a, b) => b.fat - a.fat).slice(0, 50);
    }

    function renderLeaderboard() {
      const board = combineBoards();
      leaderboardList.innerHTML = "";
      let myRank = null;
      board.forEach((entry, i) => {
        if (entry.id === state.playerId) myRank = i + 1;
        const row = document.createElement("div");
        row.className = "leaderboard-item";
        const mine = entry.id === state.playerId;
        row.style.background = mine ? "rgba(52, 211, 153, 0.2)" : "transparent";
        row.innerHTML = `<div>${i + 1}.</div><div>${entry.name}${mine ? " (You)" : ""}</div><div>${entry.fat} fat</div>`;
        leaderboardList.appendChild(row);
      });

      const errorText = state.leaderboardError ? ` ‚Ä¢ ${state.leaderboardError}` : "";
      myRankText.textContent = myRank ? `Your place: #${myRank} with ${state.totalFatEarned} fat${errorText}` : `Play to get ranked.${errorText}`;
    }

    function rollHelperType() {
      const roll = Math.random() * 100;
      let sum = 0;
      for (const helper of helperRarityTable) {
        sum += helper.chance;
        if (roll <= sum) return helper;
      }
      return helperRarityTable[0];
    }

    function addHelperFromRoll() {
      if (state.helperCount >= 5) return;
      const helper = rollHelperType();
      state.helperInventory.push({ ...helper, id: `h-${Math.random().toString(36).slice(2)}` });
      state.helperCount = Math.min(5, state.helperInventory.length);
      setStatus(`Rolled ${helper.rarity} ${helper.type} ${helper.icon}!`, "#a7f3d0");
    }

    function showWavePopup(text) {
      wavePopup.textContent = text;
      wavePopup.classList.add("show");
      clearTimeout(showWavePopup.timer);
      showWavePopup.timer = setTimeout(() => wavePopup.classList.remove("show"), 2200);
    }

    function buyItem(id, amount = 1) {
      const item = shopItems.find(i => i.id === id);
      if (!item) return;
      const count = Math.max(1, Math.min(100, Number(amount) || 1));
      const total = item.cost * count;
      if (state.coins < total) {
        setStatus(`Need ${total} coins for ${count}x ${item.name}`, "#fca5a5");
        return;
      }
      const already = state.boostPurchases[id] || 0;
      const itemMax = getBoostMax(item);
      const allowed = itemMax ? Math.max(0, itemMax - already) : count;
      if (allowed <= 0) {
        setStatus(`${item.name} is already maxed!`, "#fca5a5");
        return;
      }
      const finalCount = Math.min(count, allowed);
      const finalTotal = item.cost * finalCount;
      if (state.coins < finalTotal) {
        setStatus(`Need ${finalTotal} coins for ${finalCount}x ${item.name}`, "#fca5a5");
        return;
      }
      state.coins -= finalTotal;
      for (let i = 0; i < finalCount; i++) item.apply(state);
      state.boostPurchases[id] = already + finalCount;
      state.uiDirty = true;
      setStatus(`Bought ${finalCount}x ${item.name}!`, "#86efac");
    }

    function buyPcAccessory(id) {
      const item = accessoryShopItems.find(i => i.id === id);
      if (!item) return;
      if (state.coins < item.cost) return;
      state.coins -= item.cost;
      state.pcOwned[id] = (state.pcOwned[id] || 0) + 1;
      state.uiDirty = true;
      setStatus(`Bought ${item.name}`, "#86efac");
    }

    function togglePcEquip(id) {
      if (!(state.pcOwned[id] > 0)) return;
      state.pcEquipped[id] = !state.pcEquipped[id];
      state.uiDirty = true;
      setStatus(state.pcEquipped[id] ? `Equipped ${id}` : `Unequipped ${id}`, "#93c5fd");
    }

    function travelToZone(idx) {
      const zone = zones[idx];
      if (!zone) return;
      if (state.totalFatEarned < zone.unlockAt || state.zoneIndex === idx) return;
      state.zoneIndex = idx;
      state.uiDirty = true;
      setStatus(`Traveled to ${zone.name}`, "#86efac");
    }

    function maybeAutoUnlockAndTravel() {
      let newest = 0;
      for (let i = zones.length - 1; i >= 0; i--) {
        if (state.totalFatEarned >= zones[i].unlockAt) { newest = i; break; }
      }
      if (newest > state.highestUnlockedZone) {
        state.highestUnlockedZone = newest;
        state.zoneIndex = newest;
        state.uiDirty = true;
        setStatus(`${zones[newest].name} unlocked! Auto-traveled üöÄ`, "#86efac");
      }
    }


    const enemyTypes = {
      bandit: { name: "Rat Bandit", hp: 50, speed: 1.8, damage: 4, defense: 0, badge: "üó°Ô∏è", primary: "#fca5a5", secondary: "#b91c1c" },
      shooter: { name: "Rat Shooter", hp: 150, speed: 1.1, damage: 5, defense: 10, range: 220, fireRate: 900, badge: "üî´", primary: "#93c5fd", secondary: "#1d4ed8" },
      fast: { name: "Fast Rat", hp: 25, speed: 3.6, damage: 3, defense: 0, badge: "‚ö°", primary: "#fef08a", secondary: "#ca8a04" },
      king: { name: "KING RAT üëë", hp: 1000, speed: 0.6, damage: 12, defense: 20, boss: true, badge: "üëë", primary: "#e9d5ff", secondary: "#6d28d9" },
      bruiser: { name: "Brute Rat", hp: 260, speed: 1.05, damage: 11, defense: 12, badge: "ü™ì", primary: "#fdba74", secondary: "#c2410c" },
      shadow: { name: "Shadow Rat", hp: 120, speed: 3.9, damage: 9, defense: 4, badge: "üåë", primary: "#a5b4fc", secondary: "#312e81" },
      pyro: { name: "Pyro Rat", hp: 180, speed: 1.9, damage: 10, defense: 6, range: 240, fireRate: 700, defensePierce: 3, debuff: "noregen", badge: "üî•", primary: "#fda4af", secondary: "#b91c1c" },
      assassin: { name: "Assassin Rat", hp: 420, speed: 4.6, damage: 18, defense: 20, defensePierce: 12, debuff: "slow", badge: "ü©∏", primary: "#c4b5fd", secondary: "#4c1d95" },
      juggernaut: { name: "Juggernaut Rat", hp: 2400, speed: 0.95, damage: 30, defense: 65, defensePierce: 20, debuff: "noregen", badge: "üõ°Ô∏è", primary: "#fdba74", secondary: "#7c2d12" },
      void: { name: "Void Rat", hp: 1800, speed: 2.5, damage: 25, defense: 40, range: 280, fireRate: 520, defensePierce: 18, debuff: "vuln", badge: "üï≥Ô∏è", primary: "#93c5fd", secondary: "#1e3a8a" },
      apex: { name: "APEX TITAN RAT ‚ò†Ô∏è", hp: 50000, speed: 1.2, damage: 65, defense: 300, boss: true, range: 360, fireRate: 420, defensePierce: 180, debuff: "noregen", ultraRate: 6000, badge: "‚ò†Ô∏è", primary: "#fecaca", secondary: "#7f1d1d" },
      plague: { name: "Plague Rat", hp: 3200, speed: 2.1, damage: 38, defense: 90, range: 300, fireRate: 620, defensePierce: 26, debuff: "noregen", badge: "‚ò£Ô∏è", primary: "#86efac", secondary: "#166534" },
      railgun: { name: "Railgun Rat", hp: 4600, speed: 1.5, damage: 44, defense: 110, range: 360, fireRate: 780, defensePierce: 45, debuff: "vuln", badge: "üöÑ", primary: "#bfdbfe", secondary: "#1d4ed8" },
      fishron: { name: "DUKE RATRON ü¶à", hp: 98000, speed: 2.2, damage: 95, defense: 420, boss: true, range: 420, fireRate: 340, defensePierce: 220, debuff: "slow", ultraRate: 5200, badge: "ü¶à", primary: "#67e8f9", secondary: "#0e7490" },
      empress: { name: "EMPRESS OF LIGHT RAT ‚ú®", hp: 145000, speed: 2.5, damage: 120, defense: 520, boss: true, range: 460, fireRate: 300, defensePierce: 280, debuff: "vuln", ultraRate: 4600, badge: "‚ú®", primary: "#fbcfe8", secondary: "#a21caf" },
      stormlord: { name: "Stormlord Rat ‚ö°", hp: 170000, speed: 2.3, damage: 130, defense: 560, boss: true, range: 470, fireRate: 290, defensePierce: 300, debuff: "slow", ultraRate: 4300, badge: "‚ö°", primary: "#bfdbfe", secondary: "#1d4ed8" },
      abyss: { name: "Abyss Rat üåä", hp: 200000, speed: 2.1, damage: 140, defense: 600, boss: true, range: 490, fireRate: 280, defensePierce: 320, debuff: "noregen", ultraRate: 4200, badge: "üåä", primary: "#7dd3fc", secondary: "#155e75" },
      nebula: { name: "Nebula Rat üåå", hp: 240000, speed: 2.4, damage: 150, defense: 650, boss: true, range: 510, fireRate: 270, defensePierce: 340, debuff: "vuln", ultraRate: 4100, badge: "üåå", primary: "#c4b5fd", secondary: "#5b21b6" },
      inferno: { name: "Inferno Rat üî•", hp: 280000, speed: 2.2, damage: 165, defense: 700, boss: true, range: 520, fireRate: 260, defensePierce: 360, debuff: "noregen", ultraRate: 4000, badge: "üî•", primary: "#fdba74", secondary: "#9a3412" },
      chrono: { name: "Chrono Rat ‚è≥", hp: 320000, speed: 2.5, damage: 180, defense: 760, boss: true, range: 530, fireRate: 250, defensePierce: 390, debuff: "slow", ultraRate: 3900, badge: "‚è≥", primary: "#fde68a", secondary: "#a16207" },
      voidemperor: { name: "Void Emperor Rat üëÅÔ∏è", hp: 370000, speed: 2.4, damage: 190, defense: 820, boss: true, range: 550, fireRate: 240, defensePierce: 420, debuff: "vuln", ultraRate: 3800, badge: "üëÅÔ∏è", primary: "#a5b4fc", secondary: "#312e81" },
      dread: { name: "Dread Rat ‚ò†Ô∏è", hp: 430000, speed: 2.6, damage: 205, defense: 900, boss: true, range: 560, fireRate: 235, defensePierce: 450, debuff: "noregen", ultraRate: 3700, badge: "‚ò†Ô∏è", primary: "#fecaca", secondary: "#7f1d1d" },
      omen: { name: "Omen Rat üîÆ", hp: 470000, speed: 2.7, damage: 220, defense: 980, boss: true, range: 580, fireRate: 230, defensePierce: 480, debuff: "slow", ultraRate: 3600, badge: "üîÆ", primary: "#f0abfc", secondary: "#86198f" },
      lunatic: { name: "LUNATIC RAT üåÄ", hp: 500000, speed: 2.9, damage: 260, defense: 500, boss: true, range: 620, fireRate: 220, defensePierce: 500, debuff: "vuln", ultraRate: 3400, badge: "üåÄ", primary: "#e2e8f0", secondary: "#334155" },
      lunatic_clone: { name: "Lunatic Clone", hp: 18000, speed: 3.1, damage: 120, defense: 45, range: 420, fireRate: 380, defensePierce: 120, debuff: "vuln", badge: "üåÄ", primary: "#cbd5e1", secondary: "#475569" },
      windling: { name: "Windling Rat", hp: 2200, speed: 3.8, damage: 90, defense: 120, range: 300, fireRate: 540, defensePierce: 180, debuff: "slow", badge: "üå™Ô∏è", primary: "#bae6fd", secondary: "#0c4a6e" },
      waterling: { name: "Waterling Rat", hp: 2400, speed: 3.2, damage: 95, defense: 140, range: 310, fireRate: 520, defensePierce: 190, debuff: "noregen", badge: "üíß", primary: "#99f6e4", secondary: "#115e59" }
    };


    function milestoneBossForWave(wave) {
      const table = {
        10: "king", 20: "apex", 30: "fishron", 40: "empress", 50: "stormlord", 60: "abyss",
        70: "nebula", 80: "inferno", 90: "chrono", 100: "voidemperor", 110: "dread", 120: "omen", 130: "lunatic"
      };
      return table[wave] || null;
    }

    function pickEnemyType() {
      const milestoneBoss = milestoneBossForWave(state.wave);
      if (milestoneBoss && !state.bossMilestoneSpawned[state.wave]) return milestoneBoss;
      if (state.modeEnemyMultiplier > 1.45 && Math.random() < 0.18) return "king";
      const roll = Math.random();
      if (state.wave >= 130) {
        if (roll < 0.3) return "lunatic_clone";
        if (roll < 0.52) return "omen";
        if (roll < 0.72) return "dread";
        if (roll < 0.86) return "voidemperor";
        return "chrono";
      }
      if (state.wave >= 40) {
        if (roll < 0.2) return "empress";
        if (roll < 0.36) return "fishron";
        if (roll < 0.52) return "railgun";
        if (roll < 0.68) return "void";
        if (roll < 0.84) return "juggernaut";
        return "assassin";
      }
      if (state.wave >= 30) {
        if (roll < 0.24) return "fishron";
        if (roll < 0.42) return "railgun";
        if (roll < 0.58) return "plague";
        if (roll < 0.74) return "void";
        if (roll < 0.88) return "juggernaut";
        return "assassin";
      }
      if (state.wave >= 20) {
        if (roll < 0.15) return "void";
        if (roll < 0.28) return "juggernaut";
        if (roll < 0.42) return "plague";
        if (roll < 0.56) return "railgun";
        if (roll < 0.7) return "assassin";
        if (roll < 0.84) return "pyro";
        return "shadow";
      }
      if (state.wave >= 15) {
        if (roll < 0.22) return "bruiser";
        if (roll < 0.4) return "assassin";
        if (roll < 0.6) return "pyro";
        if (roll < 0.78) return "shadow";
        return "shooter";
      }
      if (state.wave >= 10) {
        if (roll < 0.25) return "bandit";
        if (roll < 0.45) return "fast";
        if (roll < 0.62) return "shooter";
        if (roll < 0.78) return "shadow";
        if (roll < 0.9) return "bruiser";
        return "pyro";
      }
      if (roll < 0.5) return "bandit";
      if (roll < 0.78) return "fast";
      return "shooter";
    }

    function updateBossHud() {
      const boss = state.enemies.find(e => e.id === state.bossEnemyId);
      if (!boss) {
        bossHpWrap.style.display = "none";
        state.bossEnemyId = null;
        return;
      }
      bossHpWrap.style.display = "block";
      const ratio = Math.max(0, boss.hp / boss.maxHp);
      bossHpFill.style.width = `${(ratio * 100).toFixed(1)}%`;
      bossHpLabel.textContent = `${boss.name} ${Math.max(0, Math.ceil(boss.hp))}/${boss.maxHp} HP`;
    }

    function damageEnemy(enemy, amount) {
      const effectiveEnemyDefense = Math.max(0, (enemy.defense || 0) - state.playerDefensePierce);
      const real = Math.max(1, amount - effectiveEnemyDefense * 0.5);
      enemy.hp -= real;
      enemy.wasDamaged = true;
      const hpFill = document.querySelector(`#${enemy.id} .enemy-hp-fill`);
      const hpWrap = document.querySelector(`#${enemy.id} .enemy-hp`);
      if (hpFill && hpWrap) {
        hpWrap.style.display = "block";
        const ratio = Math.max(0, enemy.hp / enemy.maxHp);
        hpFill.style.width = `${(ratio * 100).toFixed(1)}%`;
      }
    }


    function spawnEnemyFromType(typeId, x, y, extra = {}) {
      const type = enemyTypes[typeId];
      if (!type) return;
      const enemy = {
        id: `enemy-${Math.random().toString(36).slice(2)}`,
        type: typeId,
        x: x ?? Math.random() * Math.max(20, gameArea.clientWidth - 46),
        y: y ?? Math.random() * Math.max(20, gameArea.clientHeight - 46),
        speed: type.speed * state.modeEnemyMultiplier,
        hp: type.hp,
        maxHp: type.hp,
        damage: type.damage,
        defense: type.defense || 0,
        range: type.range || 0,
        fireRate: type.fireRate || 0,
        ultraRate: type.ultraRate || 0,
        lastShot: 0,
        lastUltra: 0,
        defensePierce: type.defensePierce || 0,
        debuff: type.debuff || "",
        boss: !!type.boss,
        wasDamaged: false,
        name: type.name,
        badge: type.badge || "",
        primary: type.primary || "#d8b4fe",
        secondary: type.secondary || "#7c3aed",
        pylonZone: extra.pylonZone || null
      };
      if (enemy.boss) state.bossEnemyId = enemy.id;
      if (enemy.boss) state.bossMilestoneSpawned[state.wave] = true;
      if (enemy.type === "apex") state.wave20BossSpawned = true;
      if (enemy.type === "fishron") state.wave30BossSpawned = true;
      if (enemy.type === "empress") state.wave40BossSpawned = true;
      if (enemy.type === "lunatic") state.lunaticSpawned = true;
      state.enemies.push(enemy);
      const el = document.createElement("div");
      el.id = enemy.id;
      el.className = "enemy";
      el.style.left = `${enemy.x}px`;
      el.style.top = `${enemy.y}px`;
      el.style.setProperty("--enemy-primary", enemy.primary);
      el.style.setProperty("--enemy-secondary", enemy.secondary);
      if (enemy.boss) { el.style.width = "62px"; el.style.height = "48px"; }
      el.innerHTML = `<div class="enemy-hp"><div class="enemy-hp-fill"></div></div><span class="enemy-tail"></span><span class="enemy-eye"></span><span class="enemy-nose"></span><span class="enemy-badge">${enemy.badge || ""}</span>`;
      gameArea.appendChild(el);
      updateBossHud();
    }

    function spawnPylonsAfterLunatic() {
      if (state.pylons.length) return;
      const defs = [
        { type: "wind", label: "Wind Pylon", a: "#bae6fd", b: "#0c4a6e", enemy: "windling" },
        { type: "water", label: "Water Pylon", a: "#99f6e4", b: "#115e59", enemy: "waterling" }
      ];
      defs.forEach((def, i) => {
        const p = {
          id: `pylon-${def.type}`,
          type: def.type,
          label: def.label,
          enemyType: def.enemy,
          x: Math.random() * Math.max(80, gameArea.clientWidth - 120),
          y: Math.random() * Math.max(80, gameArea.clientHeight - 140),
          hp: 2400,
          defense: 999999,
          kills: 0,
          requiredKills: 100,
          a: def.a,
          b: def.b
        };
        state.pylons.push(p);
        const el = document.createElement("div");
        el.id = p.id;
        el.className = "pylon";
        el.style.left = `${p.x}px`;
        el.style.top = `${p.y}px`;
        el.style.setProperty("--pylon-a", p.a);
        el.style.setProperty("--pylon-b", p.b);
        el.innerHTML = `<div class="pylon-label">${p.label} (0/100)</div>`;
        gameArea.appendChild(el);
      });
      showWavePopup("üå™Ô∏èüíß Two pylons appeared! Defeat 100 zone enemies each.");
      setStatus("Pylons are protected at 999k DEF until 100 zone kills.", "#93c5fd");
    }

    function registerPylonEnemyKill(zoneType) {
      const p = state.pylons.find(x => x.type === zoneType);
      if (!p) return;
      p.kills += 1;
      if (p.kills >= p.requiredKills && p.defense > 10) {
        p.defense = 10;
        setStatus(`${p.label} shield collapsed!`, "#86efac");
      }
    }

    function updatePylons(ts) {
      if (!state.pylons.length) return;
      state.pylons.forEach(p => {
        const el = document.getElementById(p.id);
        if (el) {
          const lbl = el.querySelector('.pylon-label');
          if (lbl) lbl.textContent = `${p.label} (${Math.min(p.kills,p.requiredKills)}/${p.requiredKills}) DEF:${p.defense > 1000 ? '999k+' : p.defense}`;
        }
      });

      if (ts - state.pylonLastSpawn > 1800) {
        state.pylonLastSpawn = ts;
        state.pylons.forEach(p => {
          if (state.enemies.length < 40) {
            spawnEnemyFromType(p.enemyType, p.x + Math.random()*90 - 30, p.y + Math.random()*90 - 30, { pylonZone: p.type });
            spawnEnemyFromType(p.enemyType, p.x + Math.random()*90 - 30, p.y + Math.random()*90 - 30, { pylonZone: p.type });
          }
        });
      }

      const ratBox = { x: state.rat.x, y: state.rat.y, w: state.rat.w, h: state.rat.h };
      state.pylons = state.pylons.filter(p => {
        const pBox = { x: p.x, y: p.y, w: 56, h: 76 };
        if (intersects(ratBox, pBox)) {
          if (p.defense <= 10) {
            p.hp -= Math.max(2, getPlayerAttack() * 0.85 - p.defense * 0.5);
          }
        }
        if (p.hp <= 0) {
          document.getElementById(p.id)?.remove();
          setStatus(`${p.label} destroyed!`, "#fde68a");
          return false;
        }
        return true;
      });
      if (!state.pylons.length && state.lunaticSpawned) {
        showWavePopup("‚ö° Pylon event cleared!");
      }
    }

    function spawnEnemy() {
      const typeId = pickEnemyType();
      spawnEnemyFromType(typeId);
    }

    function spawnPcPickup() {
      const equipped = accessoryShopItems.filter(item => state.pcEquipped[item.id]);
      if (!equipped.length) return;
      const picked = equipped[Math.floor(Math.random() * equipped.length)];
      const pickup = {
        id: `pickup-${Math.random().toString(36).slice(2)}`,
        x: Math.random() * Math.max(30, gameArea.clientWidth - 34),
        y: Math.random() * Math.max(30, gameArea.clientHeight - 34),
        bonusFat: 3 + state.wave,
        bonusCoins: 5,
        emoji: picked.spawn
      };
      state.pickups.push(pickup);
      const el = document.createElement("div");
      el.id = pickup.id;
      el.className = "pickup";
      el.style.left = `${pickup.x}px`;
      el.style.top = `${pickup.y}px`;
      el.textContent = pickup.emoji;
      gameArea.appendChild(el);
    }

    function spawnFood() {
      const zone = currentZone();
      const emoji = Math.random() > 0.45 ? "üçî" : "üçü";
      const food = {
        id: Math.random().toString(36).slice(2),
        x: Math.random() * (gameArea.clientWidth - 32),
        y: Math.random() * (gameArea.clientHeight - 32),
        fatValue: zone.foodFat + state.fatPerFood - 1,
        coinValue: (emoji === "üçî" ? 3 : 2) + state.coinBoost,
        emoji
      };
      state.foods.push(food);
      const el = document.createElement("div");
      el.id = food.id;
      el.className = "food";
      el.style.left = `${food.x}px`;
      el.style.top = `${food.y}px`;
      el.textContent = food.emoji;
      gameArea.appendChild(el);
    }

    function intersects(a, b) {
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }

    function clampRat() {
      state.rat.x = Math.max(2, Math.min(state.rat.x, gameArea.clientWidth - state.rat.w - 2));
      state.rat.y = Math.max(2, Math.min(state.rat.y, gameArea.clientHeight - state.rat.h - 2));
    }

    function updateRat() {
      const baseMoveSpeed = state.speed + (state.currentMode === "rush" ? 0.9 : 0) + (state.pcEquipped.keyboard ? 0.5 : 0);
      const moveSpeed = Date.now() < state.slowedUntil ? baseMoveSpeed * 0.68 : baseMoveSpeed;
      if (state.keys.ArrowUp || state.keys.w || state.touch.up) state.rat.y -= moveSpeed;
      if (state.keys.ArrowDown || state.keys.s || state.touch.down) state.rat.y += moveSpeed;
      if (state.keys.ArrowLeft || state.keys.a || state.touch.left) state.rat.x -= moveSpeed;
      if (state.keys.ArrowRight || state.keys.d || state.touch.right) state.rat.x += moveSpeed;
      clampRat();
      ratEl.style.left = `${state.rat.x}px`;
      ratEl.style.top = `${state.rat.y}px`;
    }

    function collectFood() {
      const ratBox = { x: state.rat.x, y: state.rat.y, w: state.rat.w, h: state.rat.h };
      let gained = false;
      state.foods = state.foods.filter(food => {
        const hit = intersects(ratBox, { x: food.x, y: food.y, w: 24, h: 24 });
        if (!hit) return true;
        const comboBoost = Math.min(1 + (state.combo - 1) * 0.08, 2.2);
        const fatGain = Math.max(1, Math.round(food.fatValue * state.modeFatMultiplier * (1 + getPlayerFatBonus()) * comboBoost));
        state.fat += fatGain;
        state.totalFatEarned += fatGain;
        state.coins += food.coinValue + state.modeCoinBonus;
        state.combo = Math.min(state.combo + 1, 25);
        document.getElementById(food.id)?.remove();
        gained = true;
        return false;
      });
      if (gained) {
        state.uiDirty = true;
        syncMyScore();
      } else {
        state.combo = Math.max(1, state.combo - 0.03);
      }
    }


    function applyEnemyDebuff(enemy) {
      const now = Date.now();
      if (enemy.debuff === "noregen") state.regenBlockedUntil = Math.max(state.regenBlockedUntil, now + 3200);
      if (enemy.debuff === "slow") state.slowedUntil = Math.max(state.slowedUntil, now + 2400);
      if (enemy.debuff === "vuln") state.vulnUntil = Math.max(state.vulnUntil, now + 3000);
    }

    function dealDamageToPlayer(enemy, rawDamage) {
      const effectiveDefense = Math.max(0, getPlayerDefense() - (enemy.defensePierce || 0));
      const damage = Math.max(0.5, rawDamage - effectiveDefense * 0.5);
      const vulnMultiplier = Date.now() < state.vulnUntil ? 1.28 : 1;
      state.hp -= damage * vulnMultiplier;
      applyEnemyDebuff(enemy);
    }

    function spawnEnemyBullet(enemy, ratCenterX, ratCenterY, override = {}) {
      const fromX = enemy.x + (enemy.boss ? 30 : 22);
      const fromY = enemy.y + (enemy.boss ? 24 : 18);
      const dirX = ratCenterX - fromX;
      const dirY = ratCenterY - fromY;
      const dist = Math.hypot(dirX, dirY) || 1;
      const speed = override.speed || (enemy.boss ? 5.2 : 4.2);
      const bullet = {
        id: `bullet-${Math.random().toString(36).slice(2)}`,
        x: fromX,
        y: fromY,
        vx: (dirX / dist) * speed,
        vy: (dirY / dist) * speed,
        damage: override.damage || enemy.damage,
        defensePierce: override.defensePierce ?? enemy.defensePierce ?? 0,
        debuff: override.debuff || enemy.debuff || "",
        life: override.life || (enemy.boss ? 2400 : 1800),
        size: override.size || 14
      };
      state.enemyBullets.push(bullet);
      const el = document.createElement("div");
      el.id = bullet.id;
      el.className = "enemy-bullet";
      el.style.width = `${bullet.size}px`;
      el.style.height = `${bullet.size}px`;
      el.style.left = `${bullet.x}px`;
      el.style.top = `${bullet.y}px`;
      gameArea.appendChild(el);
    }

    function updateEnemyBullets(dtMs) {
      const ratBox = { x: state.rat.x, y: state.rat.y, w: state.rat.w, h: state.rat.h };
      state.enemyBullets = state.enemyBullets.filter(bullet => {
        bullet.x += bullet.vx;
        bullet.y += bullet.vy;
        bullet.life -= dtMs;

        const out = bullet.x < -20 || bullet.y < -20 || bullet.x > gameArea.clientWidth + 20 || bullet.y > gameArea.clientHeight + 20 || bullet.life <= 0;
        const bulletBox = { x: bullet.x, y: bullet.y, w: bullet.size, h: bullet.size };
        const hitRat = intersects(ratBox, bulletBox);

        const el = document.getElementById(bullet.id);
        if (el) {
          el.style.left = `${bullet.x}px`;
          el.style.top = `${bullet.y}px`;
        }

        if (hitRat) {
          dealDamageToPlayer(bullet, bullet.damage);
          el?.remove();
          return false;
        }

        if (out) {
          el?.remove();
          return false;
        }

        return true;
      });
    }

    function updateEnemies(ts) {
      const ratCenterX = state.rat.x + state.rat.w / 2;
      const ratCenterY = state.rat.y + state.rat.h / 2;
      state.enemies.forEach(enemy => {
        const dx = ratCenterX - enemy.x;
        const dy = ratCenterY - enemy.y;
        const dist = Math.hypot(dx, dy) || 1;

        if (enemy.range && dist < enemy.range) {
          if (ts - enemy.lastShot > enemy.fireRate) {
            spawnEnemyBullet(enemy, ratCenterX, ratCenterY);
            enemy.lastShot = ts;
          }
          if (enemy.ultraRate && ts - enemy.lastUltra > enemy.ultraRate) {
            if (enemy.type === "lunatic") {
              for (let i = 0; i < 4; i++) spawnEnemyFromType("lunatic_clone", enemy.x + (Math.random()*160-80), enemy.y + (Math.random()*120-60), { pylonZone: "none" });
              for (let i = 0; i < 20; i++) {
                const angle = (Math.PI * 2 * i) / 20 + (ts / 500);
                spawnEnemyBullet(enemy, enemy.x + Math.cos(angle) * 260, enemy.y + Math.sin(angle) * 260, { speed: 6.8, damage: enemy.damage * 1.25, size: 20, life: 2800, debuff: "vuln" });
              }
              showWavePopup("üåÄ LUNATIC RAT ritual clones unleashed!");
            } else if (enemy.type === "fishron") {
              for (let i = 0; i < 3; i++) {
                spawnEnemyBullet(enemy, ratCenterX + (i - 1) * 80, ratCenterY, { speed: 8.2, damage: enemy.damage * 1.2, size: 18, life: 1500, debuff: "slow" });
              }
              enemy.x += (dx / dist) * 120;
              enemy.y += (dy / dist) * 120;
              showWavePopup("ü¶à DUKE RATRON dash assault!");
            } else if (enemy.type === "empress") {
              for (let i = 0; i < 18; i++) {
                const angle = (Math.PI * 2 * i) / 18 + (ts / 600);
                const targetX = enemy.x + Math.cos(angle) * 220;
                const targetY = enemy.y + Math.sin(angle) * 220;
                spawnEnemyBullet(enemy, targetX, targetY, { speed: 5.4, damage: enemy.damage * 1.05, size: 26, life: 3200, debuff: "vuln" });
              }
              showWavePopup("‚ú® EMPRESS OF LIGHT RAT prism barrage!");
            } else {
              for (let i = 0; i < 14; i++) {
                const angle = (Math.PI * 2 * i) / 14;
                const targetX = enemy.x + Math.cos(angle) * 130;
                const targetY = enemy.y + Math.sin(angle) * 130;
                spawnEnemyBullet(enemy, targetX, targetY, { speed: 6.5, damage: enemy.damage * 1.8, size: 22, life: 2600, defensePierce: (enemy.defensePierce || 0) + 60, debuff: "noregen" });
              }
              if (dist < 240) dealDamageToPlayer(enemy, enemy.damage * 1.4);
              showWavePopup("‚ö†Ô∏è APEX TITAN RAT used ULTRA ATTACK!");
            }
            enemy.lastUltra = ts;
          }
        } else {
          enemy.x += (dx / dist) * enemy.speed;
          enemy.y += (dy / dist) * enemy.speed;
        }

        const enemyEl = document.getElementById(enemy.id);
        if (enemyEl) {
          enemyEl.style.left = `${enemy.x}px`;
          enemyEl.style.top = `${enemy.y}px`;
        }
      });

      const ratBox = { x: state.rat.x, y: state.rat.y, w: state.rat.w, h: state.rat.h };
      state.enemies = state.enemies.filter(enemy => {
        const enemyBox = { x: enemy.x, y: enemy.y, w: enemy.boss ? 46 : 34, h: enemy.boss ? 46 : 34 };
        if (intersects(ratBox, enemyBox)) {
          dealDamageToPlayer(enemy, enemy.damage * 0.04);
          damageEnemy(enemy, getPlayerAttack() * 0.65);
        }
        if (enemy.hp <= 0) {
          state.coins += enemy.boss ? 120 : enemy.type === "shooter" ? 18 : 10;
          state.totalFatEarned += enemy.boss ? 80 : enemy.type === "shooter" ? 8 : 5;
          document.getElementById(enemy.id)?.remove();
          if (enemy.boss) {
            setStatus(`${enemy.name} defeated!`, "#fde68a");
            if (enemy.type === "lunatic") spawnPylonsAfterLunatic();
          }
          if (enemy.pylonZone) registerPylonEnemyKill(enemy.pylonZone);
          state.uiDirty = true;
          return false;
        }
        return true;
      });

      updateBossHud();
      if (state.hp <= 0) {
        state.hp = getPlayerMaxHp();
        state.wave = Math.max(1, state.wave - 1);
        state.fat = Math.max(0, state.fat - 30);
        state.combo = 1;
        state.enemyBullets.forEach(b => document.getElementById(b.id)?.remove());
        state.enemyBullets = [];
        setStatus("You got bonked! Respawned with HP reset.", "#fca5a5");
      }
    }


    function ensureHelperRats() {
      while (state.helperRats.length < state.helperCount) {
        const helper = {
          id: `helper-${Math.random().toString(36).slice(2)}`,
          x: state.rat.x - 20,
          y: state.rat.y + 20,
          swing: Math.random() * Math.PI * 2
        };
        state.helperRats.push(helper);
        const el = document.createElement("div");
        el.id = helper.id;
        el.className = "helper-rat";
        el.innerHTML = `<span class="helper-tail"></span><span class="helper-eye"></span>`;
        gameArea.appendChild(el);
      }
      while (state.helperRats.length > state.helperCount) {
        const removed = state.helperRats.pop();
        document.getElementById(removed.id)?.remove();
      }
    }

    function updateHelperRats(ts) {
      ensureHelperRats();
      const aliveEnemies = state.enemies.filter(e => e.hp > 0);
      state.helperRats.forEach((helper, idx) => {
        const helperMeta = state.helperInventory[idx] || helperRarityTable[0];
        helper.swing += 0.08 + idx * 0.005;
        const orbit = 42 + idx * 8;
        helper.x += ((state.rat.x + Math.cos(helper.swing) * orbit) - helper.x) * 0.2;
        helper.y += ((state.rat.y + 18 + Math.sin(helper.swing * 1.2) * 16) - helper.y) * 0.2;
        const el = document.getElementById(helper.id);
        if (el) {
          el.style.left = `${helper.x}px`;
          el.style.top = `${helper.y}px`;
        }

        let target = null;
        let best = Infinity;
        aliveEnemies.forEach(enemy => {
          const d = Math.hypot(enemy.x - helper.x, enemy.y - helper.y);
          if (d < best) { best = d; target = enemy; }
        });

        if (target && best < (helperMeta.range || 96)) {
          const damage = helperMeta.attack + state.helperAttack + getPlayerAttack() * (helperMeta.style === "ranged" ? 0.13 : 0.18);
          damageEnemy(target, damage);
          if (el) {
            el.style.transform = "scale(1.16) translateY(-2px)";
            setTimeout(() => {
              if (document.getElementById(helper.id)) el.style.transform = "";
            }, 90);
          }
        }
      });
    }

    function collectPickups() {
      const ratBox = { x: state.rat.x, y: state.rat.y, w: state.rat.w, h: state.rat.h };
      state.pickups = state.pickups.filter(p => {
        if (!intersects(ratBox, { x: p.x, y: p.y, w: 28, h: 28 })) return true;
        state.totalFatEarned += p.bonusFat;
        state.coins += p.bonusCoins;
        state.fat += p.bonusFat;
        document.getElementById(p.id)?.remove();
        state.uiDirty = true;
        return false;
      });
    }

    function renderAll() {
      renderHUD();
      renderShop();
      renderZones();
      renderPcShop();
      renderModes();
      renderHelperRarityList();
      renderLeaderboard();
      state.uiDirty = false;
    }


    function startWave(wave) {
      state.waveStarted = true;
      const baseCount = 4 + wave * 2;
      state.waveSpawnLeft = wave >= 20 ? baseCount + 10 : wave >= 15 ? baseCount + 6 : wave >= 10 ? baseCount + 3 : baseCount;
      state.waveSpawnTick = 0;
      if (wave === 130) {
        showWavePopup("LUNATIC RAT HAS SPAWNED ! 500k hp ");
        setStatus("LUNATIC RAT HAS SPAWNED ! 500k hp ", "#fde68a");
      } else if (wave === 120) {
        showWavePopup("u dont listen to me?");
        setStatus("u dont listen to me?", "#fda4af");
      } else if (wave === 110) {
        showWavePopup("know your place...");
        setStatus("know your place...", "#fda4af");
      } else if (wave === 40) {
        showWavePopup("WAVE 40 started... EMPRESS OF LIGHT RAT descended!");
        setStatus("Final nightmare: huge but dodgeable light attacks!", "#f9a8d4");
      } else if (wave === 30) {
        showWavePopup("WAVE 30 started... DUKE RATRON rises from the sewers!");
        setStatus("Boss fight: shark-like dash attacks incoming!", "#67e8f9");
      } else if (wave === 20) {
        showWavePopup("WAVE 20 started... APEX TITAN RAT awakened!");
        setStatus("Final boss incoming: 50,000 HP / 300 DEF", "#fca5a5");
      } else if (wave === 10) {
        showWavePopup("WAVE 10 started... new enemies added.");
        setStatus("Hard mode enemies unlocked!", "#fca5a5");
      } else {
        showWavePopup(`WAVE ${wave} started!`);
        setStatus(`Wave ${wave} started!`, "#93c5fd");
      }
      state.uiDirty = true;
    }

    function gameLoop(ts) {
      const dt = Math.min(50, ts - (state.lastFrameTs || ts));
      state.lastFrameTs = ts;
      const spawnEvery = Math.max(170, (currentZone().foodRate - state.spawnBoost) * state.modeSpawnMultiplier);
      if (ts - state.lastSpawn > spawnEvery && state.foods.length < 26) {
        spawnFood();
        state.lastSpawn = ts;
      }

      const bossAlive = state.enemies.some(enemy => enemy.boss);
      const maxAlive = Math.min(6 + Math.floor(state.wave * 0.8), 34);
      const enemySpawnEvery = Math.max(620, 2350 - state.wave * 14);
      if (!bossAlive && state.waveSpawnLeft > 0 && ts - state.lastEnemySpawn > enemySpawnEvery && state.enemies.length < maxAlive) {
        spawnEnemy();
        state.waveSpawnLeft -= 1;
        state.lastEnemySpawn = ts;
      }

      if (ts - state.lastPickupSpawn > 6000) {
        spawnPcPickup();
        state.lastPickupSpawn = ts;
      }

      const regenRate = Date.now() < state.regenBlockedUntil ? 0 : getPlayerHpRegen();
      state.hp = Math.min(getPlayerMaxHp(), state.hp + regenRate);
      if (!state.waveStarted) {
        startWave(state.wave);
      } else if (!bossAlive && state.waveSpawnLeft <= 0 && state.enemies.length === 0) {
        state.wave += 1;
        startWave(state.wave);
      }

      updateRat();
      collectFood();
      collectPickups();
      updateHelperRats(ts);
      updateEnemies(ts);
      updateEnemyBullets(dt);
      updatePylons(ts);
      maybeAutoUnlockAndTravel();

      if (state.uiDirty) renderAll();
      else renderHUD();

      requestAnimationFrame(gameLoop);
    }

    document.getElementById("openShopBtn").addEventListener("click", () => openModal("#shopModal"));
    document.getElementById("openZonesBtn").addEventListener("click", () => openModal("#zonesModal"));
    document.getElementById("openRatBtn").addEventListener("click", () => openModal("#ratModal"));
    document.getElementById("openPcBtn").addEventListener("click", () => openModal("#pcModal"));
    document.getElementById("openModesBtn").addEventListener("click", () => openModal("#modesModal"));
    document.getElementById("openLeaderboardBtn").addEventListener("click", async () => {
      openModal("#leaderboardModal");
      await refreshLeaderboardFromApi();
      await syncMyScore(true);
      await refreshLeaderboardFromApi();
    });

    document.querySelectorAll("[data-close]").forEach(btn => btn.addEventListener("click", () => closeModal(btn.dataset.close)));

    shopList.addEventListener("click", e => {
      const btn = e.target.closest("button[data-buy]");
      if (!btn) return;
      const itemId = btn.dataset.buy;
      let amount = Number(btn.dataset.amount || 1);
      if (btn.dataset.amount === "custom") {
        const input = shopList.querySelector(`input[data-qty="${itemId}"]`);
        amount = Number(input?.value || 1);
      }
      buyItem(itemId, amount);
    });

    pcList.addEventListener("click", e => {
      const buy = e.target.closest("button[data-pc-buy]");
      if (buy) {
        buyPcAccessory(buy.dataset.pcBuy);
        return;
      }
      const equip = e.target.closest("button[data-pc-equip]");
      if (equip) togglePcEquip(equip.dataset.pcEquip);
    });

    zonesList.addEventListener("click", e => {
      const btn = e.target.closest("button[data-zone]");
      if (!btn) return;
      travelToZone(Number(btn.dataset.zone));
    });

    modesList.addEventListener("click", e => {
      const btn = e.target.closest("button[data-mode]");
      if (!btn) return;
      setGameMode(btn.dataset.mode);
    });

    document.getElementById("saveRatBtn").addEventListener("click", () => {
      state.ratName = document.getElementById("ratNameInput").value.trim() || "Chunky";
      state.ratPrimary = document.getElementById("ratPrimaryInput").value;
      state.ratSecondary = document.getElementById("ratSecondaryInput").value;
      state.ratEye = document.getElementById("ratEyeInput").value;
      state.ratNose = document.getElementById("ratNoseInput").value;
      state.ratTail = document.getElementById("ratTailInput").value;
      state.ratPattern = document.getElementById("ratPatternInput").value;
      state.ratAccessory = document.getElementById("ratAccessoryInput").value;
      state.uiDirty = true;
      syncMyScore(true);
      renderLeaderboard();
      setStatus("Rat customization saved!", "#86efac");
    });


    window.addEventListener("keydown", e => {
      state.keys[e.key] = true;
      state.keys[e.key.toLowerCase()] = true;
    });

    window.addEventListener("keyup", e => {
      state.keys[e.key] = false;
      state.keys[e.key.toLowerCase()] = false;
    });

    const mobileControls = document.getElementById("mobileControls");
    mobileControls.querySelectorAll("[data-touch]").forEach(btn => {
      const dir = btn.dataset.touch;
      const down = event => {
        event.preventDefault();
        state.touch[dir] = true;
      };
      const up = event => {
        event.preventDefault();
        state.touch[dir] = false;
      };
      btn.addEventListener("pointerdown", down);
      btn.addEventListener("pointerup", up);
      btn.addEventListener("pointerleave", up);
      btn.addEventListener("pointercancel", up);
    });

    window.addEventListener("resize", clampRat);

    async function initializeLeaderboardOnJoin() {
      await refreshLeaderboardFromApi();
      await syncMyScore(true);
      await refreshLeaderboardFromApi();
      setInterval(() => {
        refreshLeaderboardFromApi();
      }, 20000);
    }

    setGameMode("classic");
    renderAll();
    initializeLeaderboardOnJoin();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
